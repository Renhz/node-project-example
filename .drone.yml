kind: pipeline
type: docker
name: charger-event-subscriber

clone:
  depth: 50

steps:
  - name: install
    image: node:18-buster
    commands:
      - corepack enable
      - yarn install --immutable --immutable-cache
    when:
      branch:
        - master
        - develop
  - name: unit-test
    image: node:18-buster
    commands:
      - yarn test
    when:
      branch:
        - master
        - develop
  - name: release
    image: node:18-buster
    environment:
      GIT_AUTHOR_NAME: renhz
      GIT_AUTHOR_EMAIL: ren.zheng@maxwin.com.tw
      GIT_COMMITTER_NAME: ${DRONE_COMMIT_AUTHOR_NAME}
      GIT_COMMITTER_EMAIL: ${DRONE_COMMIT_AUTHOR_EMAIL}
      GIT_CREDENTIALS:
        from_secret: bitbucket_username_password
    commands:
      - yarn semantic-release
    when:
      branch:
        - master
      event:
        - push

  - name: push
    image: plugins/docker
    settings:
      repo: cicd-so-happy.maxwin.com.tw:5000/charger-event-subscriber
      registry: cicd-so-happy.maxwin.com.tw:5000
      tags: ${DRONE_TAG}
      insecure: true
      dry_run: true
    when:
      event:
        - tag